<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detail IKU</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { background: #f0f4f5; font-family: "Segoe UI", sans-serif; }
      .table-responsive { max-height: 75vh; overflow: auto; position: relative; }
      table { width: max-content; border-collapse: collapse; }
      .table th, .table td { white-space: nowrap; vertical-align: middle; font-size: 0.72rem; }

      /* Sticky header baris 1 */
      .table thead tr:nth-child(1) th { position: sticky; top: 0; background-color: #198754 !important; color: white !important; z-index: 4; }
      /* Sticky header baris 2 (bulan) */
      .table thead tr:nth-child(2) th { position: sticky; top: 34px; background-color: #198754 !important; color: white !important; z-index: 3; }
      /* Sticky header baris 3 (subheader) */
      .table thead tr:nth-child(3) th { position: sticky; top: 68px; background-color: #198754 !important; color: white !important; z-index: 2; }

      .updated { background-color: #d1e7dd !important; }
      @media print {
  .no-print {
    display: none !important;
  }
  body {
    background: white !important;
  }
  body * {
    visibility: hidden;
  }
  .table-responsive, .table-responsive * {
    visibility: visible;
  }
  .table-responsive {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }
}

    </style>
  </head>
  <body>
    <div class="container-fluid py-4" style="max-width:95%;margin:auto">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-center mb-4">
            <h4 class="fw-bold mb-0 no-print" >INDIKATOR KINERJA UTAMA PUSKESMAS</h4>
          </div>

          <div class="d-flex justify-content-start mb-3">
            <a href="home.html" class="btn btn-outline-success shadow-sm no-print">‚¨ÖÔ∏è Kembali</a>
          </div>

          <div class="text-end mt-3 mb-2">
            <button id="btnSimpanSemua" class="btn btn-outline-success ms-2 shadow-sm mb-2 no-print">üíæ Simpan Semua Perubahan</button>
          </div>

        <div class="d-flex justify-content-end mb-3 gap-2">

            <label class="me-2 fw-bold no-print">Filter Bulan:</label>
            <select id="filterBulan" class="form-select form-select-sm" style="width: 200px;">
              <option value="all">Semua Bulan</option>
              <option value="Jan">Januari</option>
              <option value="Feb">Februari</option>
              <option value="Mar">Maret</option>
              <option value="Apr">April</option>
              <option value="Mei">Mei</option>
              <option value="Jun">Juni</option>
              <option value="Jul">Juli</option>
              <option value="Agst">Agustus</option>
              <option value="Sept">September</option>
              <option value="Okt">Oktober</option>
              <option value="Nov">November</option>
              <option value="Des">Desember</option>
            </select>
            <!-- Tombol print -->
  <button id="btnPrint" class="btn btn-outline-primary btn-sm shadow-sm no-print">
    üñ®Ô∏è Print
  </button>
          </div>
          <h5 class="text-center">MONITORING INDIKATOR KINERJA UTAMA (IKU) BULANAN</h5>
          <div class="table-responsive" style="font-size:11px">
            <table class="table table-bordered table-striped table-hover">
              <thead class="table-success text-center align-middle">
                <tr>
                  <th rowspan="3">No</th>
                  <th rowspan="3">Kategori</th>
                  <th rowspan="3">Indikator Utama</th>
                  <th rowspan="3">Target Tahunan</th>
                  <th colspan="2" rowspan="2">Sasaran</th>
                  <th id="hasil-kegiatan" colspan="36">Hasil Kegiatan</th>
                  <th rowspan="3">Bukti Dukung</th>
                </tr>
                <!-- row untuk nama bulan (dinamis) -->
                <tr id="bulan-header-row"></tr>
                <!-- row subheader (Tahun/Bulan untuk sasaran + Bulan Ini/Kumulatif/% untuk tiap bulan) -->
                <tr id="bulan-subheader"></tr>
              </thead>
              <tbody id="data-body">
                <!-- data masuk via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- scripts -->
    <script>
      const endpoint = "https://script.google.com/macros/s/AKfycby8eRYUDkA8HJ5IAsFJJcQ1-1nYvTTNtnJR9yYBAi43unsoePmBmS1dHqfP_NzYnTAX/exec";

      const bulanList = [
        { key: "Jan", label: "Januari" },
        { key: "Feb", label: "Februari" },
        { key: "Mar", label: "Maret" },
        { key: "Apr", label: "April" },
        { key: "Mei", label: "Mei" },
        { key: "Jun", label: "Juni" },
        { key: "Jul", label: "Juli" },
        { key: "Agst", label: "Agustus" },
        { key: "Sept", label: "September" },
        { key: "Okt", label: "Oktober" },
        { key: "Nov", label: "November" },
        { key: "Des", label: "Desember" }
      ];

      async function loadData(filterBulan = "all") {
        try {
          const tbody = document.getElementById("data-body");
          const hasilTh = document.getElementById("hasil-kegiatan");          // <th> Hasil Kegiatan (th)
          const bulanHeaderRow = document.getElementById("bulan-header-row"); // <tr> nama bulan
          const bulanSubRow = document.getElementById("bulan-subheader");     // <tr> subheader

          // tampilkan spinner sementara
          tbody.innerHTML = `
            <tr>
              <td colspan="60" class="text-center py-4">
                <div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>
                <div class="mt-2">Memuat data...</div>
              </td>
            </tr>
          `;
          // kosongkan header bulan dulu
          bulanHeaderRow.innerHTML = "";
          bulanSubRow.innerHTML = "";

          // fetch data
          const res = await fetch(endpoint);
          const data = await res.json();

          // pilih bulan yang akan ditampilkan
          let bulanFiltered = bulanList;
          if (filterBulan !== "all") bulanFiltered = bulanList.filter(b => b.key === filterBulan);

          // atur colspan Hasil Kegiatan (3 kolom per bulan)
          hasilTh.colSpan = bulanFiltered.length * 3;

          // isi row bulan (baris ke-2)
          bulanFiltered.forEach(b => {
            bulanHeaderRow.innerHTML += `<th colspan="3">${b.label}</th>`;
          });

          // isi subheader (baris ke-3) -> tambahkan kolom Sasaran (Tahun,Bulan) di awal
          let subHtml = `<th>Tahun</th><th>Bulan</th>`;
          bulanFiltered.forEach(() => {
            subHtml += `<th>Bulan Ini</th><th>Kumulatif Abs</th><th>%</th>`;
          });
          bulanSubRow.innerHTML = subHtml;

          // render data
          tbody.innerHTML = "";
          data.forEach((row, i) => {
            // tampilkan target tahunan aman
            let targetDisplay = "-";
            if (row["Target Tahunan"] != null) {
              if (typeof row["Target Tahunan"] === "number") {
                targetDisplay = (row["Target Tahunan"] * 100).toFixed(0) + "%";
              } else {
                targetDisplay = row["Target Tahunan"];
              }
            }

            // angka target untuk perhitungan: pakai Sasaran Tahunan (kolom E)
            let targetNumber = 0;
            if (row["Sasaran Tahunan"]) {
              targetNumber = parseFloat(String(row["Sasaran Tahunan"]).replace(/[^\d.-]/g, "")) || 0;
            }

            let tr = `<tr>
              <td>${i + 1}</td>
              <td>${row["kategori"] || ""}</td>
              <td style="min-width:300px">${row["Indikator Utama"] || ""}</td>
              <td width="60px" class="text-center">${targetDisplay}</td>
              <td class="text-center">${row["Sasaran Tahunan"] || ""}</td>
              <td class="text-center">${row["Sasaran Bulanan"] || ""}</td>`;

            let kumulatif = 0;
            bulanFiltered.forEach((b) => {
              const bulanDisplay = row[b.key] || "";
              const bulanIni = parseFloat(String(row[b.key]).replace(/[^\d.-]/g, "")) || 0;
              kumulatif += bulanIni;
              let persen = "";
              if (targetNumber > 0) persen = ((kumulatif / targetNumber) * 100).toFixed(2) + "%";

              tr += `
                <td class="text-center">${bulanDisplay}</td>
                <td class="text-center">${kumulatif}</td>
                <td class="text-center">${persen}</td>`;
            });

            tr += `<td><a href="${row["Bukti Dukung"] || "#"}" target="_blank">Link</a></td></tr>`;
            tbody.innerHTML += tr;
          });

        } catch (err) {
          console.error("Error load data:", err);
          document.getElementById("data-body").innerHTML = `<tr><td colspan="60" class="text-center text-danger">Gagal memuat data</td></tr>`;
        }
      }

      // set default ke bulan sekarang (index 0=Jan)
      const bulanSekarang = new Date().getMonth();
      const defaultKode = bulanList[bulanSekarang].key;
      document.getElementById("filterBulan").value = defaultKode;

      // load awal
      loadData(defaultKode);

      // event filter change
      document.getElementById("filterBulan").addEventListener("change", function () {
        loadData(this.value === "all" ? "all" : this.value);
      });
      // tombol print
document.getElementById("btnPrint").addEventListener("click", function () {
  window.print();
});
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
