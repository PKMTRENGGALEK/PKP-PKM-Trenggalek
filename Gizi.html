<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Klaster</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Select2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- <script src="auth.js"></script> -->
    <style>
      body {
        background: #f0f4f5;
        font-family: "Segoe UI", sans-serif;
      }

      .logo {
        max-height: 100px;
      }

      .table-responsive {
        max-height: 75vh;
        overflow: auto;
        position: relative;
      }

      table {
        width: max-content;
        border-collapse: collapse;
      }

      .table th,
      .table td {
        white-space: nowrap;
        vertical-align: middle;
        font-size: 0.72rem;
      }

      /* Sticky header baris 1 */
      .table thead tr:nth-child(1) th {
        position: sticky;
        top: 0;
        background-color: #198754 !important;
        color: white !important;
        z-index: 3;
      }

      /* Sticky header baris 2 (bulan) */
      .table thead tr:nth-child(2) th {
        position: sticky;
        top: 30px; /* Sesuaikan sesuai tinggi header baris 1 */
        background-color: #198754 !important;
        color: white !important;
        z-index: 2;
      }

      .bulan-input {
        width: 45px;
        font-size: 0.72rem;
        text-align: center;
      }

      .updated {
        background-color: #d1e7dd !important;
      }
    </style>
    
  </head>
  <body>
    <div class="container-fluid py-4" style="max-width: 95%; margin: auto">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-center mb-4">
            <!-- <img
          src="https://puskesmastrenggalek.github.io/SIP/assets/pkm.png"
          alt="Logo"
          style="max-height: 80px"
          class="mb-2"
        /> -->
            <h4 class="fw-bold mb-0">Detail Program Klaster</h4>
          </div>

          <div class="d-flex justify-content-start gap-2 mb-3">
            <a href="home.html" class="btn btn-outline-success shadow-sm">
              拘勇 Kembali
            </a>
            <a
              id="analisaLink"
              href="#"
              class="btn btn-outline-danger shadow-sm"
            >
              Analisa
            </a>
          </div>

          <div class="text-end mt-3 mb-2">
            <button
              id="btnExportExcel"
              class="btn btn-outline-success shadow-sm mb-2"
            >
              游닌 Export ke Excel
            </button>
            <!-- <button
              id="btnSimpanSemua"
              class="btn btn-outline-success ms-2 shadow-sm mb-2"
            >
              游 Simpan Semua Perubahan
            </button> -->
          </div>
          <div class="mb-2">
            <label for="bulanFilter" class="form-label fw-semibold">Filter Bulan:</label>
            <select id="bulanFilter" class="form-select form-select-sm" style="width: 200px; display: inline-block;">
              <option value="all">Tampilkan Semua</option>
              <option value="januari">Januari</option>
              <option value="februari">Februari</option>
              <option value="maret">Maret</option>
              <option value="april">April</option>
              <option value="mei">Mei</option>
              <option value="juni">Juni</option>
              <option value="juli">Juli</option>
              <option value="agustus">Agustus</option>
              <option value="september">September</option>
              <option value="oktober">Oktober</option>
              <option value="november">November</option>
              <option value="desember">Desember</option>

            </select>
          </div>
          
          <a href="https://docs.google.com/spreadsheets/d/10GrrZ9akiB1--1DGJdEJtSkEapot2uLtdOC6wWbxLGg/edit?gid=1752999212#gid=1752999212"
            target="_blank" class="btn btn-sm btn-outline-danger rounded shadow mb-2">Input Data</a>
          
            <div class="table-responsive" style="font-size: 11px">
              <table class="table table-bordered table-striped align-middle mb-0" id="programTable">
                <thead class="table-success text-center align-middle">
                  <tr id="tableHeaderMain"></tr>
                  <tr id="tableHeaderSub"></tr>
                </thead>
                <tbody id="tableBody">
                  <tr><td colspan="25" class="text-center">Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
            
            <!-- Scripts -->
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
            <script>
              const endpoint =
                "https://script.google.com/macros/s/AKfycbzcwt4BBtvpqEgCfY6wMp7HCfnzPOqqO1WF873oy6r-qB_cf_EhZi-0ZguiZYqMdZvb/exec";
            
              const bulanKeys = {
                januari: ["Total Sasaran Januari", "Target Januari", "Capaian Januari", "Cakupan Rill Januari"],
                februari: ["Total Sasaran Februari", "Target Februari", "Capaian Februari", "Cakupan Rill Februari"],
                maret: ["Total Sasaran Maret", "Target Maret", "Capaian Maret", "Cakupan Rill Maret"],
                april: ["Total Sasaran April", "Target April", "Capaian April", "Cakupan Rill April"],
                mei: ["Total Sasaran Mei", "Target Mei", "Capaian Mei", "Cakupan Rill Mei"],
                juni: ["Total Sasaran Juni", "Target Juni", "Capaian Juni", "Cakupan Rill Juni"],
                juli: ["Total Sasaran Juli", "Target Juli", "Capaian Juli", "Cakupan Rill Juli"],
                agustus: ["Total Sasaran Agustus", "Target Agustus", "Capaian Agustus", "Cakupan Rill Agustus"],
                september: ["Total Sasaran September", "Target September", "Capaian September", "Cakupan Rill September"],
                oktober: ["Total Sasaran Oktober", "Target Oktober", "Capaian Oktober", "Cakupan Rill Oktober"],
                november: ["Total Sasaran November", "Target November", "Capaian November", "Cakupan Rill November"],
                desember: ["Total Sasaran Desember", "Target Desember", "Capaian Desember", "Cakupan Rill Desember"],
              };
            
              const bulanLabel = {
                januari: "Januari", februari: "Februari", maret: "Maret", april: "April", mei: "Mei",
                juni: "Juni", juli: "Juli", agustus: "Agustus", september: "September",
                oktober: "Oktober", november: "November", desember: "Desember",
              };
            
              let allData = [];
              let rows = []; // 游릭 Tambahan: simpan data aktif global
            
              function getKategoriCakupan(value) {
                const num = parseFloat(value);
                if (isNaN(num)) return "-";
                if (num >= 97.5) return "Sangat Rendah";
                if (num >= 90.1) return "Sedang";
                if (num >= 80.1) return "Tinggi";
                if (num >= 70.1) return "Sangat Tinggi";
                return "Rendah";
              }
            
              function renderCell(value) {
                if (value === null || value === undefined || value === "")
                  return `<td class="text-center">-</td>`;
                const num = parseFloat(value);
                const displayValue = !isNaN(num)
                  ? Math.round(num * 100) / 100
                  : value;
                return `<td class="text-center">${displayValue}</td>`;
              }
            
              function formatPercent(val) {
                if (val === undefined || val === null || val === "") return "0%";
                let num = parseFloat(String(val).replace(",", ".").replace("%", "").trim());
                if (isNaN(num)) return val;
                if (num <= 1) num *= 100;
                return num.toFixed(2) + "%";
              }
            
              function renderHeader(filterBulan) {
                const mainHeader = document.getElementById("tableHeaderMain");
                const subHeader = document.getElementById("tableHeaderSub");
            
                let mainHTML = `
                  <th rowspan="2" width="50px">No</th>
                  <th rowspan="2">Klaster</th>
                  <th rowspan="2">Induk</th>
                  <th rowspan="2">Sub</th>
                  <th rowspan="2">Kategori</th>
                  <th rowspan="2">Kegiatan</th>
                  <th rowspan="2">Indikator Kerja</th>
                  <th rowspan="2">Target 2025</th>
                `;
                let subHTML = "";
            
                if (filterBulan === "all") {
                  for (const key in bulanKeys) {
                    const label = bulanLabel[key];
                    mainHTML += `<th colspan="4" class="table-success">${label}</th>`;
                    subHTML += `<th>Total Sasaran</th><th>Target</th><th>Capaian</th><th>Cakupan Rill</th>`;
                  }
                } else {
                  const label = bulanLabel[filterBulan];
                  mainHTML += `<th colspan="4" class="table-success">${label}</th>`;
                  subHTML += `<th>Total Sasaran ${label}</th><th>Target ${label}</th><th>Capaian ${label}</th><th>Cakupan Rill ${label}</th>`;
                }
            
                mainHTML += `<th rowspan="2">Keterangan</th>`;
            
                mainHeader.innerHTML = mainHTML;
                subHeader.innerHTML = subHTML;
              }
            
              function renderTable(data, filterBulan = "all") {
                const tableBody = document.getElementById("tableBody");
                tableBody.innerHTML = "";
                const fragment = document.createDocumentFragment();
                let index = 1;
            
                renderHeader(filterBulan);
            
                if (!data || data.length === 0) {
                  const tr = document.createElement("tr");
                  tr.innerHTML = `<td colspan="25" class="text-center">Tidak ada data</td>`;
                  tableBody.appendChild(tr);
                  return;
                }
            
                rows = data; // 游릭 Simpan semua data untuk referensi modal
            
                for (const row of data) {
                  let html = `
                    <td>${index}</td>
                    <td>${row["Klaster"] || "-"}</td>
                    <td>${row["Induk"] || "-"}</td>
                    <td>${row["Sub"] || "-"}</td>
                    <td>${row["Kategori"] || "-"}</td>
                    <td>
                      ${row["Kegiatan"] || "-"}
                      <button 
                        class="btn btn-sm btn-outline-primary py-0 px-1 show-info-btn shadow ml-2"
                        data-type="DO" 
                        data-id="${index}">
                        DO
                      </button>
                    </td>
                    <td>${row["Indikator Kerja"] || "-"}</td>
                    <td>${row["Target 2025"] || "-"}</td>
                  `;
            
                  let nilaiCakupan = null;
            
                  if (filterBulan === "all") {
                    for (const bulan in bulanKeys) {
                      for (const key of bulanKeys[bulan]) {
                        const value = row[key];
                        if (key.toLowerCase().includes("cakupan")) nilaiCakupan = value;
                        if (key.toLowerCase().includes("capaian") || key.toLowerCase().includes("cakupan"))
                          html += renderCell(formatPercent(value));
                        else html += renderCell(value);
                      }
                    }
                  } else {
                    for (const key of bulanKeys[filterBulan]) {
                      const value = row[key];
                      if (key.toLowerCase().includes("cakupan")) nilaiCakupan = value;
                      if (key.toLowerCase().includes("capaian") || key.toLowerCase().includes("cakupan"))
                        html += renderCell(formatPercent(value));
                      else html += renderCell(value);
                    }
                  }
            
                  html += `<td class="text-center">${getKategoriCakupan(nilaiCakupan)}</td>`;
            
                  const tr = document.createElement("tr");
                  tr.innerHTML = html;
                  fragment.appendChild(tr);
                  index++;
                }
            
                tableBody.appendChild(fragment);
              }
            
              function loadData(defaultBulan) {
                const tableBody = document.getElementById("tableBody");
                tableBody.innerHTML = `
                  <tr><td colspan="25" class="text-center py-4">
                    <div class="spinner-border text-success" role="status"></div>
                    <div class="mt-2 text-success fw-semibold">Memuat data...</div>
                  </td></tr>`;
            
                fetch(endpoint)
                  .then((res) => res.json())
                  .then((data) => {
                    allData = data;
                    renderTable(allData, defaultBulan);
                  })
                  .catch((err) => {
                    console.error(err);
                    tableBody.innerHTML = `<tr><td colspan="25" class="text-danger text-center">Gagal memuat data.</td></tr>`;
                  });
              }
            
              document.getElementById("bulanFilter").addEventListener("change", (e) => {
                const key = e.target.value || "all";
                renderTable(allData, key);
              });
            
              const bulanList = ["januari", "februari", "maret", "april", "mei", "juni", "juli", "agustus", "september", "oktober", "november", "desember"];
              const bulanSekarang = bulanList[new Date().getMonth()];
              document.getElementById("bulanFilter").value = bulanSekarang;
              loadData(bulanSekarang);
            </script>
            
            <!-- 游릭 Modal untuk DO -->
            <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="infoModalLabel">Info</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                  </div>
                  <div class="modal-body" id="modalContent">...</div>
                </div>
              </div>
            </div>
            
            <!-- 游릭 Script Modal -->
            <script>
              document.addEventListener("click", function (e) {
                if (e.target.classList.contains("show-info-btn")) {
                  const id = e.target.dataset.id;
                  const row = rows[parseInt(id) - 1]; // cari berdasarkan nomor urut tabel
                  if (!row) return;
            
                  const content = row["DO"] || "<em>Belum ada data</em>";
                  document.getElementById("modalContent").innerHTML = content;
                  document.getElementById("infoModalLabel").textContent = `Detail DO - No ${id}`;
            
                  const modal = new bootstrap.Modal(document.getElementById("infoModal"));
                  modal.show();
                }
              });
            </script>
            
  </body>
</html>
