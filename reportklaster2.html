<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report - Manajemen</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- <script src="auth.js"></script> -->
    <style>
      /* --- gaya global tetap --- */
      body {
        background: linear-gradient(to bottom, #ffffff, #c8facc);
        font-family: "Segoe UI", sans-serif;
        padding-top: 80px;
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .container {
        flex: 1;
      }

      .navbar {
        background-color: #ffffff;
        border-bottom: 1px solid #e0e0e0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .navbar-brand {
        font-weight: 600;
        color: #7d752e !important;
      }

      .section-title {
        text-align: center;
        margin: 20px 0;
        color: #2e7d32;
        font-size: 1.3rem;
        font-weight: 700;
      }

      .form-select {
        max-width: 280px;
        margin-bottom: 15px;
        font-size: 0.85rem;
        padding: 4px 8px;
      }

      .card {
        background-color: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 10px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      }

      .sticky-header {
        max-height: 450px;
        overflow-y: auto;
        border-radius: 10px;
        box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.05);
      }

      /* --- gaya tabel --- */
      table {
        font-size: 0.75rem; /* lebih kecil */
      }

      .table th,
      .table td {
        padding: 4px 6px; /* sel lebih rapat */
        vertical-align: middle;
      }

      .tableFixHead thead tr:nth-child(1) th {
        position: sticky;
        top: 0;
        background: #5e6d08;
        z-index: 3;
      }

      .tableFixHead thead tr:nth-child(2) th {
        position: sticky;
        top: 28px; /* sesuaikan dengan tinggi baris 1 */
        background: #5e6d08;
        z-index: 2;
      }

      footer {
        background: rgba(255, 255, 255, 0.8);
        text-align: center;
        padding: 0.6rem;
        font-size: 0.8rem;
        color: #555;
        box-shadow: 0 -1px 6px rgba(0, 0, 0, 0.05);
      }
      /* Induk & Sub rata kiri */
      #programTable td.text-start,
      #programTable th.text-start {
        text-align: left !important;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar fixed-top bg-white shadow-sm">
      <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="#">PKP 2025 - Data Program</a>
      </div>
    </nav>

    <!-- Konten -->
    <div class="container">
      <div class="card shadow">
        <div class="card-body">
          <a href="home.html" class="btn btn-outline-success shadow-sm">
            ⬅️ Kembali
          </a>
          <h2 class="section-title">
            Instrumen Penghitungan Klaster Pelayanan Kesehatan Ibu dan Anak
          </h2>

          <!-- Filter Program -->
          <select class="form-select" id="filterProgram">
            <option value="">Semua Program</option>
          </select>

          <!-- Tabel -->
          <div class="table-responsive tableFixHead sticky-header">
            <table
              class="table table-sm table-bordered table-striped align-middle text-center"
              id="programTable"
            >
              <thead class="table-success text-center align-middle">
                <tr>
                  <th class="text-white">No</th>
                  <th class="text-white">Kegiatan</th>
                  <th class="text-white">Indikator Kinerja</th>
                  <th class="text-white">Target tahun 2025</th>
                  <th class="text-white">Satuan Sasaran</th>
                  <th class="text-white">Total sasaran</th>
                  <th class="text-white">Target Sasaran</th>
                  <th class="text-white">Pencapaian (dalam satuan sasaran)</th>
                  <th class="text-white">% Nilai Kinerja</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr id="loadingRow">
                  <td colspan="10" class="text-center py-4">
                    <div
                      class="spinner-border text-success"
                      role="status"
                    ></div>
                    <div class="mt-2 text-success fw-semibold">
                      Memuat data...
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="fixed-bottom">
      &copy; 2025 Puskesmas Trenggalek | Data Program PKP
    </footer>
  </body>
</html>
<script>
  const endpoint =
    "https://script.google.com/macros/s/AKfycbyXUb1qcb9YTr8nv4C1Ad2p2ifqosTbRBF0B-rg8bb1f2Tc9hy4LMwrIaZia1YIkPMD6w/exec";
  const tableBody = document.getElementById("tableBody");
  const filterProgram = document.getElementById("filterProgram");

  let rows = []; // simpan semua data Klaster 2

  // helper badge warna
  function getBadge(persen) {
    if (persen >= 80) {
      return `<span class="badge bg-success">${persen}%</span>`;
    } else if (persen >= 50) {
      return `<span class="badge bg-warning text-dark">${persen}%</span>`;
    } else {
      return `<span class="badge bg-danger">${persen}%</span>`;
    }
  }

  // Render tabel dengan grouping Induk > Sub
  function renderTable(data) {
    const fragment = document.createDocumentFragment();
    let index = 1;

    // group by Induk & Sub
    const grouped = {};
    data.forEach((row) => {
      const induk = row["Induk"] || "Lainnya";
      const sub = row["Sub"] || "Lainnya";
      if (!grouped[induk]) grouped[induk] = {};
      if (!grouped[induk][sub]) grouped[induk][sub] = [];
      grouped[induk][sub].push(row);
    });

    for (const induk in grouped) {
      // baris induk
      const indukRow = document.createElement("tr");
      indukRow.style.backgroundColor = "#f8d7da"; // merah muda
      indukRow.innerHTML = `<td colspan="9" class="fw-bold text-danger text-start">${induk}</td>`;
      fragment.appendChild(indukRow);

      for (const sub in grouped[induk]) {
        // baris sub
        const subRow = document.createElement("tr");
        subRow.style.backgroundColor = "#cff4fc"; // biru muda
        subRow.innerHTML = `<td colspan="9" class="fw-semibold text-primary ps-3 text-start">${sub}</td>`;
        fragment.appendChild(subRow);

        // data indikator
        grouped[induk][sub].forEach((row) => {
          const tr = document.createElement("tr");

          const target = parseFloat(row["Target Sasaran"]) || 0;
          const pencapaian =
            parseFloat(row["Pencapaian (dalam satuan sasaran)"]) || 0;

          let persentase = "-";
          if (target > 0) {
            let hasil = pencapaian / target;
            if (hasil >= 1) hasil = 1; // max 100%
            persentase = (hasil * 100).toFixed(2);
          }

          tr.innerHTML = `
                <td>${index++}</td>
                <td>${row["Kegiatan"] || "-"}</td>
                <td class="text-start">${row["Indikator Kerja"] || "-"}</td>
                <td>${row["Target 2025"] || "-"}</td>
                <td>${row["Satuan Sasaran"] || "-"}</td>
                <td>${row["Total Sasaran"] || "-"}</td>
                <td>${target || "-"}</td>
                <td>${pencapaian || "-"}</td>
                <td>${persentase !== "-" ? getBadge(persentase) : "-"}</td>
              `;

          fragment.appendChild(tr);
        });
      }
    }

    tableBody.innerHTML = "";
    tableBody.appendChild(fragment);
  }

  // Load data hanya Klaster 2
  function loadData() {
    tableBody.innerHTML = `
          <tr><td colspan="9" class="text-center py-4">
            <div class="spinner-border text-success" role="status"></div>
            <div class="mt-2 text-success fw-semibold">Memuat data...</div>
          </td></tr>`;

    fetch(endpoint)
      .then((res) => res.json())
      .then((data) => {
        // filter hanya Klaster 2
        rows = data.filter((item) => item.Klaster === "Klaster 2");

        if (rows.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="9" class="text-danger text-center">Data Klaster 2 tidak ditemukan.</td></tr>';
          return;
        }

        // isi dropdown program
        const programs = [
          ...new Set(rows.map((r) => r.Kegiatan).filter(Boolean)),
        ];
        filterProgram.innerHTML =
          '<option value="">Semua Program</option>' +
          programs.map((p) => `<option value="${p}">${p}</option>`).join("");

        // render tabel pertama kali
        renderTable(rows);
      })
      .catch((err) => {
        console.error("Fetch error:", err);
        tableBody.innerHTML =
          '<tr><td colspan="9" class="text-danger text-center">Gagal memuat data.</td></tr>';
      });
  }

  // Filter program
  filterProgram.addEventListener("change", () => {
    const selected = filterProgram.value;
    if (!selected) {
      renderTable(rows);
    } else {
      const filtered = rows.filter((r) => r.Kegiatan === selected);
      renderTable(filtered);
    }
  });

  // jalankan saat halaman load
  loadData();
</script>
