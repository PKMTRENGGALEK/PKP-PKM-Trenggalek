<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PKP - Tabel Program</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(to bottom, #ffffff, #c8facc);
        font-family: "Segoe UI", sans-serif;
        padding-top: 80px;
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .container {
        flex: 1;
      }

      .navbar {
        background-color: #ffffff;
        border-bottom: 1px solid #e0e0e0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .navbar-brand {
        font-weight: 600;
        color: #2e7d32 !important;
      }

      .section-title {
        text-align: center;
        margin: 20px 0;
        color: #2e7d32;
        font-size: 1.6rem;
        font-weight: 700;
      }

      .form-select {
        max-width: 300px;
        margin-bottom: 20px;
      }

      .program-heading {
        background-color: #e8f5e9;
        font-weight: bold;
        color: #2e7d32;
      }

      .card {
        background-color: rgba(255, 255, 255, 0.85);
        border: none;
        backdrop-filter: blur(4px);
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }

      .sticky-header {
        max-height: 500px;
        overflow-y: auto;
        border-radius: 12px;
        box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.05);
      }

      table {
        font-size: 0.85rem;
      }

      .tableFixHead thead tr:nth-child(1) th {
        position: sticky;
        top: 0;
        background: #c1f0cb;
        z-index: 3;
        text-align: center;
      }

      .tableFixHead thead tr:nth-child(2) th {
        position: sticky;
        top: 40px;
        background: #e2f9e3;
        z-index: 2;
        text-align: center;
      }

      .table thead th,
      .table tbody td {
        vertical-align: middle;
      }

      footer {
        background: rgba(255, 255, 255, 0.8);
        text-align: center;
        padding: 1rem;
        font-size: 0.9rem;
        color: #555;
        backdrop-filter: blur(4px);
        box-shadow: 0 -1px 6px rgba(0, 0, 0, 0.05);
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar fixed-top bg-white shadow-sm">
      <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="#">PKP 2025 - Data Program</a>
        <button
          onclick="history.back()"
          class="btn btn-outline-success btn-sm shadow-sm"
        >
          ⬅️ Kembali
        </button>
      </div>
    </nav>

    <!-- Konten -->
    <div class="container">
      <div class="card shadow">
        <div class="card-body">
          <h2 class="section-title">
            Rekap Indikator Program Puskesmas Klaster Managemen
          </h2>

          <!-- Filter Program -->
          <select class="form-select" id="filterProgram">
            <option value="">Semua Program</option>
          </select>

          <!-- Tabel -->
          <div class="table-responsive tableFixHead sticky-header">
            <table
              class="table table-bordered table-striped align-middle"
              id="programTable"
            >
              <thead class="table-success text-center align-middle">
                <tr>
                  <th rowspan="2">No</th>
                  <th rowspan="2" style="min-width: 120px">Jenis Variabel</th>
                  <th rowspan="2" style="min-width: 250px">
                    Definisi Operasional
                  </th>
                  <th rowspan="2">0</th>
                  <th rowspan="2">4</th>
                  <th rowspan="2">7</th>
                  <th rowspan="2">10</th>
                  <th rowspan="2">Target</th>
                  <th rowspan="2">Capaian</th>
                  <th rowspan="2">Ketercapaian</th>
                  <th colspan="12">Capaian Kegiatan Program</th>
                </tr>
                <tr class="text-center">
                  <th>Jan</th>
                  <th>Feb</th>
                  <th>Mar</th>
                  <th>Apr</th>
                  <th>Mei</th>
                  <th>Juni</th>
                  <th>Juli</th>
                  <th>Agst</th>
                  <th>Sept</th>
                  <th>Okt</th>
                  <th>Nov</th>
                  <th>Des</th>
                </tr>
              </thead>
              <tbody style="font-size: 12px" id="tableBody">
                <tr id="loadingRow">
                  <td colspan="22" class="text-center py-4">
                    <div
                      class="spinner-border text-success"
                      role="status"
                    ></div>
                    <div class="mt-2 text-success fw-semibold">
                      Memuat data...
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="fixed-bottom">
      &copy; 2025 Puskesmas Trenggalek | Data Program PKP
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script Ambil Data + Filter -->
    <script>
      const endpoint =
        "https://script.google.com/macros/s/AKfycbzg84-rK9Grl_7-89tbqoXR_H5CSXyBcd45sE4zwEXSxn_DIxwP-ERWu2GaH6lDC9-S/exec";

      let allData = [];

      const tableBody = document.getElementById("tableBody");
      const filterSelect = document.getElementById("filterProgram");

      fetch(endpoint)
        .then((res) => res.json())
        .then((data) => {
          allData = data;
          populateFilter(data);
          renderTable();
        })
        .catch((err) => {
          tableBody.innerHTML =
            '<tr><td colspan="22" class="text-center text-danger">Gagal memuat data.</td></tr>';
          console.error("Fetch error:", err);
        });

      function populateFilter(data) {
        const programSet = new Set();
        data.forEach((item) => {
          const prog = item["Program"] || "Tanpa Program";
          programSet.add(prog);
        });

        [...programSet].sort().forEach((prog) => {
          const opt = document.createElement("option");
          opt.value = prog;
          opt.textContent = prog;
          filterSelect.appendChild(opt);
        });
      }

      function renderTable() {
        const loadingRow = document.getElementById("loadingRow");
        if (loadingRow) loadingRow.remove();
        const selectedProgram = filterSelect.value;
        const grouped = {};

        allData.forEach((item) => {
          const program = item["Program"] || "Tanpa Program";
          if (!grouped[program]) grouped[program] = [];
          grouped[program].push(item);
        });

        tableBody.innerHTML = "";
        let counter = 1;

        Object.entries(grouped).forEach(([program, rows]) => {
          if (selectedProgram && selectedProgram !== program) return;

          const progRow = document.createElement("tr");
          progRow.innerHTML = `<td colspan="22" class="program-heading">${program}</td>`;
          tableBody.appendChild(progRow);

          rows.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${counter++}</td>
              <td>${row["Jenis Variabel"] || ""}</td>
              <td>${row["Definisi Operasional"] || ""}</td>
              <td>${row["0"] || ""}</td>
              <td>${row["4"] || ""}</td>
              <td>${row["7"] || ""}</td>
              <td>${row["10"] || ""}</td>
              <td>${row["Target Nilai Kinerja"] || ""}</td>
              <td>${row["Capaian Pelaksanaan (Skala: 0,4,7,10)"] || ""}</td>
              <td>${row["Ketercapaian  Target Tahun n"] || ""}</td>
              <td>${row["Jan"] || ""}</td>
              <td>${row["Feb"] || ""}</td>
              <td>${row["Mar"] || ""}</td>
              <td>${row["Apr"] || ""}</td>
              <td>${row["Mei"] || ""}</td>
              <td>${row["Juni"] || ""}</td>
              <td>${row["Juli"] || ""}</td>
              <td>${row["Agst"] || ""}</td>
              <td>${row["Sept"] || ""}</td>
              <td>${row["Okt"] || ""}</td>
              <td>${row["Nov"] || ""}</td>
              <td>${row["Des"] || ""}</td>
            `;
            tableBody.appendChild(tr);
          });
        });

        if (tableBody.innerHTML === "") {
          tableBody.innerHTML =
            '<tr><td colspan="22" class="text-center text-muted">Tidak ada data untuk program ini.</td></tr>';
        }
      }

      filterSelect.addEventListener("change", renderTable);
    </script>
  </body>
</html>
