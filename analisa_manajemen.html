<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analisa Manajemen</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Select2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <script src="auth.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Tom Select CSS & JS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <style>
      body {
        background: #f0f4f5;
        font-family: "Segoe UI", sans-serif;
      }
      @media print {
        html,
        body {
          background: white !important;
          color: black !important;
          margin: 0 !important;
          padding: 0 !important;
          box-shadow: none !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          height: auto !important;
          width: 100% !important;
          overflow: visible !important;
        }

        /* SEMUA DISEMBUNYIKAN TERLEBIH DULU */
        body * {
          visibility: hidden !important;
        }

        /* H1-H6 BERSIH DARI MARGIN DAN PADDING */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          margin: 0 !important;
          padding: 0 !important;
          line-height: 1.2 !important;
        }

        /* JUDUL PRINT */
        .judul-print {
          margin: 0 !important;
          padding: 0 !important;
          line-height: 1.2 !important;
          visibility: visible !important;
          page-break-after: avoid !important; /* jaga tetap bersama tabel */
        }

        /* AREA CETAK */

        #printArea * {
          visibility: visible !important;
          margin: 0 !important;
          padding: 0 !important;
        }
        #ttd-section {
          margin-top: 1cm !important;
          page-break-inside: avoid !important;
        }

        #ttd-section img {
          display: block !important;
          margin: 15px auto !important;
          page-break-inside: avoid !important;
        }
        /* NON-PRINT */
        .no-print {
          display: none !important;
        }

        /* LAYOUT */
        .container,
        .card,
        .shadow,
        .rounded,
        .border,
        .row,
        .col-6,
        .card-body {
          background: white !important;
          box-shadow: none !important;
          border: none !important;
          overflow: visible !important;
          height: auto !important;
          max-height: none !important;
          page-break-inside: auto !important; /* ubah dari avoid ke auto */
        }

        /* TABEL */
        .table-responsive {
          overflow: visible !important;
          height: auto !important;
          max-height: none !important;
        }

        .table-responsive > table,
        table {
          width: 100% !important;
          page-break-inside: auto !important;
          break-inside: auto !important;
        }

        thead {
          display: table-header-group !important;
        }

        tfoot {
          display: table-footer-group !important;
        }

        tr,
        td,
        th {
          page-break-inside: auto !important;
        }

        /* GAMBAR */
        img {
          max-width: 100% !important;
          page-break-inside: avoid !important;
        }

        /* AREA KHUSUS */
        #ttd-section {
          page-break-inside: avoid !important;
        }
        .container,
        .row {
          margin: 0 !important;
          padding: 0 !important;
        }
        .table thead tr:nth-child(1) th,
        .table thead tr:nth-child(2) th {
          position: static !important;
          top: auto !important;
          z-index: auto !important;
        }
        /* #printArea * {
          border: 1px dashed red;
        } */
        /* UKURAN KERTAS */
        @page {
          size: A4 landscape;
          margin: 1cm;
        }
      }

      @media screen {
        #ttd-section {
          display: none;
        }
      }
      .logo {
        max-height: 100px;
      }

      .table-responsive {
        position: relative;
        max-height: 75vh;
        overflow: auto;
      }

      .table th,
      .table thead th {
        background-color: #198754 !important;
        color: white !important;
        font-size: 0.72rem;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
      }

      .table td {
        font-size: 0.72rem;
        vertical-align: middle;
        white-space: nowrap;
      }

      /* Sticky headers */
      .table thead tr:nth-child(1) th {
        position: sticky;
        top: 0;
        z-index: 3;
      }

      .table thead tr:nth-child(2) th {
        position: sticky;
        top: 34px;
        z-index: 2;
      }

      .bulan-input {
        width: 45px;
        font-size: 0.72rem;
        text-align: center;
      }

      .updated {
        background-color: #d1e7dd !important;
      }
      th.indikator-col,
      td.indikator-col {
        max-width: 700px; /* Ubah sesuai kebutuhan, misalnya 150px */
        white-space: normal;
        word-wrap: break-word;
        word-break: break-word;
      }

      .bg-biru {
        background-color: #2196f3;
        color: white;
      }
      .bg-hijau {
        background-color: #4caf50;
        color: white;
      }
      .bg-kuning {
        background-color: #ffeb3b;
        color: black;
      }
      .bg-merah {
        background-color: #f44336;
        color: white;
      }
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        display: none;
        z-index: 10;
        background: white;
        padding: 5px 10px;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body class="p-3">
    <div class="container-fluid py-4" style="max-width: 95%; margin: auto">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-3">
            <a href="index.html" class="btn btn-outline-primary btn-sm"
              >‚Üê Kembali</a
            >
            <button id="simpanBtn" class="btn btn-success btn-sm">
              üíæ Simpan Perubahan
            </button>
          </div>
          <div class="text-end mb-3">
            <button
              class="btn btn-outline-danger no-print"
              data-bs-toggle="modal"
              data-bs-target="#modalPenanggungJawab"
            >
              üñ®Ô∏è Cetak PDF
            </button>
          </div>

          <!-- Modal Pilih Penanggung Jawab -->
          <div class="modal fade" id="modalPenanggungJawab" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Pilih Penanggung Jawab</h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <select class="form-select" id="selectPenanggungJawab">
                    <option value="" selected disabled>-- Pilih --</option>

                    <option
                      value="dr. MURTI RUKIYANDARI|19800611 200903 2 004|assets/kapus.png|Kepala Puskesmas"
                    >
                      dr. MURTI RUKIYANDARI
                    </option>
                    <option
                      value="drg. DIAN SITA RISTIANA|19821022 201001 2 014|assets/diansita.png|PJ Lintas Klaster"
                    >
                      drg. DIAN SITA RISTIANA
                    </option>
                    <option
                      value="dr. Melissa Teguh|19870519 202203 2 002|assets/melisa.png|PJ Klaster 2"
                    >
                      dr. Melissa Teguh
                    </option>
                    <option
                      value="Astutik, S.S.T.,Bd|19721011 199301 2 001|assets/astutik.png|PJ Klaster 2"
                    >
                      Astutik, S.S.T.,Bd
                    </option>

                    <option
                      value="HAYUNING DEWI OCTAVIANTI, S.K.M.|19801003 200604 2 022|assets/hayuning.png|PJ Klaster 1"
                    >
                      HAYUNING DEWI OCTAVIANTI, S.K.M.
                    </option>

                    <option
                      value="DINA ANINGGARWATI, Amd.Kep.|19821208 201406 2 003|assets/dina.png|PJ Klaster 3"
                    >
                      DINA ANINGGARWATI, Amd.Kep.
                    </option>
                    <option
                      value="Nurkolis S.Kep.Ners|19780611 199803 1 005|assets/nurkolis.png|PJ Klaster 4"
                    >
                      Nurkolis S.Kep.Ners
                    </option>
                  </select>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Batal
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="pilihPJDanCetak()"
                  >
                    OK & Cetak
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Filter -->
          <div class="mb-3">
            <label for="triwulanSelect" class="form-label fw-bold"
              >Pilih Triwulan:</label
            >
            <select id="triwulanSelect" class="form-select w-auto">
              <option value="I">Triwulan I</option>
              <option value="II">Triwulan II</option>
              <option value="III">Triwulan III</option>
              <option value="IV">Triwulan IV</option>
            </select>
          </div>

          <!-- Loading -->
          <div class="loading" id="loadingIndicator">Memuat data...</div>
          <div id="printArea">
            <!-- <div class="judul-print">
              <h2>IDENTIFIKASI DAN ANALISA MASALAH PKP 2025</h2>
            </div> -->
            <h5
              id="judulKategori"
              class="fw-bold text-uppercase text-center"
            ></h5>
            <!-- Table -->
            <div class="table-responsive position-relative">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th rowspan="2">No</th>
                    <th rowspan="2">Indikator Kerja</th>
                    <th colspan="2" id="triwulanHeader">
                      Triwulan Lalu / Triwulan Ini
                    </th>
                    <th rowspan="2">% Target s/d Triwulan</th>
                    <th rowspan="2">% Cakupan s/d Triwulan</th>
                    <th rowspan="2">% Kesenjangan</th>
                    <th rowspan="2">Tren</th>
                    <th rowspan="2">Grade</th>
                    <th rowspan="2">Masalah</th>
                    <th rowspan="2">Analisa Penyebab Masalah</th>
                    <th rowspan="2">Rencana Tindak Lanjut</th>
                    <th rowspan="2">Hasil Tindak Lanjut</th>
                  </tr>
                  <tr>
                    <th id="thLalu">Triwulan Lalu</th>
                    <th id="thIni">Triwulan Ini</th>
                  </tr>
                </thead>
                <tbody id="data-body">
                  <tr>
                    <td colspan="13"></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- Tanda Tangan (TTD) -->
            <div class="row mt-4" id="ttd-section">
              <!-- Penanggung Jawab -->
              <div class="col-6 text-center" style="min-height: 160px">
                <p class="mb-0">
                  Mengetahui,<br />
                  <span id="pj">PJ Klaster 1 Manajemen</span>
                </p>

                <!-- Gambar tanda tangan -->
                <img
                  id="ttdPenanggungJawab"
                  src="assets/hayuning.png"
                  alt="TTD Penanggung Jawab"
                  style="
                    height: 80px;
                    margin: -15px auto -5px auto; /* atas -15px, bawah -5px */
                    display: block;
                    opacity: 0.9;
                  "
                />

                <!-- Nama & NIP -->
                <p
                  id="namaPenanggungJawab"
                  class="fw-bold text-decoration-underline mb-1"
                >
                  Hayuning Dewi Octavianti, S.KM
                </p>
                <p id="nipPenanggungJawab" class="mb-0">
                  NIP. 19801003 200604 2 022
                </p>
              </div>

              <!-- Pelaksana -->
              <div class="col-6 text-center" style="min-height: 160px">
                <p class="mb-0">Pelaksana,</p>

                <!-- Gambar tanda tangan -->
                <img
                  id="ttdPelaksana"
                  src="assets/ttd_pelaksana.png"
                  alt="TTD Pelaksana"
                  style="
                    height: 80px;
                    margin: -15px auto -5px auto; /* atas -15px, bawah -5px */
                    display: block;
                    opacity: 0.9;
                  "
                />

                <!-- Nama & NIP -->
                <p
                  id="namaPelaksana"
                  class="fw-bold text-decoration-underline mb-1"
                >
                  ..........................................
                </p>
                <p id="nipPelaksana" class="mb-0">
                  NIP. ..........................................
                </p>
              </div>
            </div>
          </div>
          <!-- Legend -->
          <div class="mt-3">
            <h6>Keterangan Warna Grade:</h6>
            <p>
              <span style="background: blue"></span> BIRU: capaian bulan ini
              lebih besar dari bulan lalu dan kumulatif di atas target
            </p>
            <p>
              <span style="background: blue"></span> BIRU: capaian bulan ini
              sama dengan bulan lalu dan kumulatif di atas target
            </p>
            <p>
              <span style="background: green"></span> HIJAU: capaian bulan ini
              lebih kecil dari bulan lalu dan kumulatif di atas target
            </p>
            <p>
              <span style="background: orange"></span> KUNING: capaian bulan ini
              lebih besar dari bulan lalu dan kumulatif di bawah target
            </p>
            <p>
              <span style="background: red"></span> MERAH: capaian bulan ini
              lebih kecil atau sama dengan bulan lalu dan kumulatif di bawah
              target
            </p>
          </div>
        </div>
      </div>
    </div>
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const programParam = params.get("program");
      if (programParam) {
        document.getElementById("judulKategori").textContent =
          programParam.toUpperCase();
      }
      const triwulanSelect = document.getElementById("triwulanSelect");
      const thLalu = document.getElementById("thLalu");
      const thIni = document.getElementById("thIni");
      const loadingIndicator = document.getElementById("loadingIndicator");

      const urutanTriwulan = ["I", "II", "III", "IV"];
      const endpoint =
        "https://script.google.com/macros/s/AKfycbzg84-rK9Grl_7-89tbqoXR_H5CSXyBcd45sE4zwEXSxn_DIxwP-ERWu2GaH6lDC9-S/exec";

      function hitungGrade(lalu, ini, target, cakupan) {
        if (ini > lalu && cakupan >= target) return "BIRU";
        if (ini === lalu && cakupan >= target) return "BIRU";
        if (ini < lalu && cakupan >= target) return "HIJAU";
        if (ini > lalu && cakupan < target) return "KUNING";
        if (ini <= lalu && cakupan < target) return "MERAH";
        return "-";
      }

      async function loadData() {
        loadingIndicator.style.display = "block";
        try {
          const res = await fetch(endpoint);
          const json = await res.json();
          const data = json.data || json;

          const normalize = (str) =>
            (str || "").toLowerCase().replace(/\s+/g, " ").trim();
          const filtered = data.filter(
            (d) => normalize(d.Program) === normalize(programParam)
          );

          const tbody = document.getElementById("data-body");
          tbody.innerHTML = "";

          if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="13">‚ùå Tidak ada data untuk program: ${programParam}</td></tr>`;
            return;
          }

          const selectedTriwulan = triwulanSelect.value || "I";
          const idxIni = urutanTriwulan.indexOf(selectedTriwulan);
          const idxLalu = idxIni === 0 ? -1 : idxIni - 1;

          thLalu.textContent =
            idxLalu === -1 ? "-" : "Triwulan " + urutanTriwulan[idxLalu];
          thIni.textContent = "Triwulan " + urutanTriwulan[idxIni];

          filtered.forEach((row, i) => {
            const twIni = urutanTriwulan[idxIni];
            const twLalu = idxLalu === -1 ? null : urutanTriwulan[idxLalu];

            const target = parseFloat(row["% Target"] || 0);
            const cakupan = parseFloat(row["% Cakupan"] || 0);
            const lalu = twLalu
              ? parseFloat(row[`Triwulan ${twLalu}`] || 0)
              : 0;
            const ini = parseFloat(row[`Triwulan ${twIni}`] || 0);

            const kesenjangan = (target - cakupan).toFixed(2);
            const tren =
              idxLalu === -1
                ? "‚û°Ô∏è"
                : ini > lalu
                ? "‚¨ÜÔ∏è"
                : ini < lalu
                ? "‚¨áÔ∏è"
                : "‚û°Ô∏è";
            const grade = hitungGrade(lalu, ini, target, cakupan);

            let gradeClass = "";
            if (grade === "BIRU") gradeClass = "bg-primary text-white";
            if (grade === "HIJAU") gradeClass = "bg-success text-white";
            if (grade === "KUNING") gradeClass = "bg-warning text-dark";
            if (grade === "MERAH") gradeClass = "bg-danger text-white";

            const kolomMapping = {
              Masalah: `Masalah_TW${twIni}`,
              Analisa:
                twIni === "I"
                  ? "Analisa_masalah_TWI"
                  : `Analisa_Masalah_TW${twIni}`,
              RTL: `RTL_TW${twIni}`,
              Hasil: `Hasil_TW${twIni}`,
            };

            tbody.innerHTML += `
              <tr>
                <td>${i + 1}</td>
                <td class="indikator-col text-start">${
                  row["Jenis Variabel"] || "-"
                }</td>
                <td>${twLalu ? row[`Triwulan ${twLalu}`] || "-" : "-"}</td>
                <td>${row[`Triwulan ${twIni}`] || "-"}</td>
                <td>${row["Target Nilai Kinerja"] || "-"}</td>
                <td>${row["% Cakupan"] || "-"}</td>
                <td>${kesenjangan}</td>
                <td>${tren}</td>
                <td class="${gradeClass}">${grade}</td>
                <td><textarea class="form-control form-control-sm masalah-textarea" data-id="${i}" data-bulan="Masalah">${
              row[kolomMapping.Masalah] || ""
            }</textarea></td>
                <td><textarea class="form-control form-control-sm analisa-textarea" data-id="${i}" data-bulan="Analisa">${
              row[kolomMapping.Analisa] || ""
            }</textarea></td>
                <td><textarea class="form-control form-control-sm rtl-textarea" data-id="${i}" data-bulan="RTL">${
              row[kolomMapping.RTL] || ""
            }</textarea></td>
                <td><textarea class="form-control form-control-sm hasil-textarea" data-id="${i}" data-bulan="Hasil">${
              row[kolomMapping.Hasil] || ""
            }</textarea></td>
              </tr>`;
          });
        } catch (e) {
          console.error("‚ö†Ô∏è Error ambil data:", e);
          tbody.innerHTML = `<tr><td colspan="13">‚ö†Ô∏è Error ambil data</td></tr>`;
        } finally {
          loadingIndicator.style.display = "none";
        }
      }

      document
        .getElementById("simpanBtn")
        .addEventListener("click", function () {
          const updates = [];
          const collect = (selector, tipe) => {
            document.querySelectorAll(selector).forEach((ta) => {
              let id = ta.getAttribute("data-id");
              const nilai = ta.value.trim();
              if (id && nilai !== "") {
                id = parseInt(id) + 1;
                updates.push({ id, tipe, nilai });
              }
            });
          };

          collect(".masalah-textarea", "Masalah");
          collect(".analisa-textarea", "Analisa");
          collect(".rtl-textarea", "RTL");
          collect(".hasil-textarea", "Hasil");

          if (updates.length === 0) {
            Swal.fire(
              "Tidak ada perubahan",
              "Silakan isi data terlebih dahulu",
              "info"
            );
            return;
          }

          const triwulan = triwulanSelect.value;
          const kolomMapping = {
            Masalah: `Masalah_TW${triwulan}`,
            Analisa:
              triwulan === "I"
                ? "Analisa_masalah_TWI"
                : `Analisa_Masalah_TW${triwulan}`,
            RTL: `RTL_TW${triwulan}`,
            Hasil: `Hasil_TW${triwulan}`,
          };

          Swal.fire({
            title: "Menyimpan data...",
            html: "Harap tunggu sebentar",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          const promises = updates.map((item) => {
            const kolom = kolomMapping[item.tipe];
            return fetch(
              `${endpoint}?action=update&id=${encodeURIComponent(
                item.id
              )}&bulan=${encodeURIComponent(kolom)}&nilai=${encodeURIComponent(
                item.nilai
              )}`
            )
              .then((res) => res.json())
              .catch(() => ({ success: false }));
          });

          Promise.all(promises)
            .then((results) => {
              Swal.close();
              const gagal = results.filter((r) => !r.success);
              if (gagal.length > 0) {
                Swal.fire(
                  "Sebagian Gagal",
                  `${gagal.length} data gagal disimpan.`,
                  "warning"
                );
              } else {
                Swal.fire(
                  "Tersimpan!",
                  "Seluruh perubahan berhasil disimpan.",
                  "success"
                );
              }
            })
            .catch((err) => {
              Swal.close();
              console.error("Kesalahan penyimpanan:", err);
              Swal.fire(
                "Error",
                "Terjadi kesalahan saat menyimpan data.",
                "error"
              );
            });
        });

      // Load awal
      loadData();
      triwulanSelect.addEventListener("change", loadData);
    </script>
  </body>
</html>
<script>
  document.getElementById("cetakPDF").addEventListener("click", () => {
    const element = document.querySelector(".table-responsive"); // Bisa diganti ke div/card lain kalau mau
    const opt = {
      margin: 0.5,
      filename: `Laporan_PKP_${selectedBulan}.pdf`,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: "in", format: "a4", orientation: "landscape" },
    };
  });

  Promise.all(promises).then((results) => {
    const gagal = results.filter((r) => !r.success);
    Swal.close();

    if (gagal.length > 0) {
      Swal.fire(
        "data Berhasil disimpan",
        // `${gagal.length} baris tidak tersimpan.`,
        "success"
      );
    } else {
      Swal.fire({
        icon: "success",
        title: "Data bulan ini berhasil disimpan!",
        timer: 1500,
        showConfirmButton: false,
      });
    }
  });
</script>
<script>
  document.getElementById("btnPrint").addEventListener("click", function () {
    const printContent = document.createElement("div");

    const tableClone = document
      .querySelector(".table-responsive")
      .cloneNode(true);
    const ttdClone = document.getElementById("ttd-section").cloneNode(true);

    printContent.appendChild(tableClone);
    printContent.appendChild(ttdClone);

    const opt = {
      margin: 0.5,
      filename: `Analisa_PKP_${new Date().toISOString().split("T")[0]}.pdf`,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        allowTaint: true,
      },
      jsPDF: {
        unit: "in",
        format: "a4",
        orientation: "landscape",
      },
    };

    html2pdf().set(opt).from(printContent).save();
  });
</script>
<script>
  function getParameterByName(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name) || "";
  }

  // Ambil nama
  const namaPelaksana = getParameterByName("nama");
  if (namaPelaksana) {
    document.getElementById("namaPelaksana").textContent = namaPelaksana;
  }

  // Ambil NIP
  const nipPelaksana = getParameterByName("nip");
  if (nipPelaksana) {
    document.getElementById("nipPelaksana").textContent =
      "NIP. " + nipPelaksana;
  }

  // Ambil gambar tanda tangan (nama file saja, misal: hayuning.png)
  const imgPelaksana = getParameterByName("img");
  if (imgPelaksana) {
    document.getElementById("ttdPelaksana").src = "assets/" + imgPelaksana;
  }
</script>
<script>
  function pilihPJDanCetak() {
    const select = document.getElementById("selectPenanggungJawab");
    const selectedValue = select?.value?.trim();

    if (!selectedValue) {
      alert("Silakan pilih Penanggung Jawab terlebih dahulu.");
      return;
    }

    const [nama, nip, img, pj] = selectedValue
      .split("|")
      .map((item) => item?.trim() || "");

    // Update tampilan di halaman
    const namaEl = document.getElementById("namaPenanggungJawab");
    const nipEl = document.getElementById("nipPenanggungJawab");
    const pjEl = document.getElementById("pj");
    const ttdImage = document.getElementById("ttdPenanggungJawab");

    if (namaEl) namaEl.textContent = nama || "-";
    if (nipEl) nipEl.textContent = nip ? "NIP. " + nip : "";
    if (pjEl) pjEl.textContent = pj || "-";

    // Update gambar tanda tangan Penanggung Jawab jika ada
    if (ttdImage) {
      ttdImage.src = img || "default-ttd.png"; // fallback gambar default
    }

    // Tutup modal
    const modalElement = document.getElementById("modalPenanggungJawab");
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (modalInstance) modalInstance.hide();

    // Delay agar modal sempat tertutup sebelum cetak
    setTimeout(() => {
      window.print();
    }, 300);
  }
</script>
<!-- tom select -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    new TomSelect("#selectPenanggungJawab", {
      create: false,
      sortField: false, // ‚õî Jangan urut otomatis
      placeholder: "Ketik untuk mencari nama...",
    });
  });
</script>
