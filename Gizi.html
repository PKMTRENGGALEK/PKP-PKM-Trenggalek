<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Klaster</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Select2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- <script src="auth.js"></script> -->
    <style>
      body {
        background: #f0f4f5;
        font-family: "Segoe UI", sans-serif;
      }

      .logo {
        max-height: 100px;
      }

      .table-responsive {
        max-height: 75vh;
        overflow: auto;
        position: relative;
      }

      table {
        width: max-content;
        border-collapse: collapse;
      }

      .table th,
      .table td {
        white-space: nowrap;
        vertical-align: middle;
        font-size: 0.72rem;
      }

      /* Sticky header baris 1 */
      .table thead tr:nth-child(1) th {
        position: sticky;
        top: 0;
        background-color: #198754 !important;
        color: white !important;
        z-index: 3;
      }

      /* Sticky header baris 2 (bulan) */
      .table thead tr:nth-child(2) th {
        position: sticky;
        top: 30px; /* Sesuaikan sesuai tinggi header baris 1 */
        background-color: #198754 !important;
        color: white !important;
        z-index: 2;
      }

      .bulan-input {
        width: 45px;
        font-size: 0.72rem;
        text-align: center;
      }

      .updated {
        background-color: #d1e7dd !important;
      }
    </style>
    
  </head>
  <body>
    <div class="container-fluid py-4" style="max-width: 95%; margin: auto">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-center mb-4">
            <!-- <img
          src="https://puskesmastrenggalek.github.io/SIP/assets/pkm.png"
          alt="Logo"
          style="max-height: 80px"
          class="mb-2"
        /> -->
            <h4 class="fw-bold mb-0">Detail Program Klaster</h4>
          </div>

          <div class="d-flex justify-content-start gap-2 mb-3">
            <a href="home.html" class="btn btn-outline-success shadow-sm">
              ‚¨ÖÔ∏è Kembali
            </a>
            <a
              id="analisaLink"
              href="#"
              class="btn btn-outline-danger shadow-sm"
            >
              Analisa
            </a>
          </div>

          <div class="text-end mt-3 mb-2">
            <button
              id="btnExportExcel"
              class="btn btn-outline-success shadow-sm mb-2"
            >
              üì• Export ke Excel
            </button>
            <!-- <button
              id="btnSimpanSemua"
              class="btn btn-outline-success ms-2 shadow-sm mb-2"
            >
              üíæ Simpan Semua Perubahan
            </button> -->
          </div>
          <div class="mb-2">
            <label for="bulanFilter" class="form-label fw-semibold">Filter Bulan:</label>
            <select id="bulanFilter" class="form-select form-select-sm" style="width: 200px; display: inline-block;">
              <option value="all">Tampilkan Semua</option>
              <option value="jan">Januari</option>
              <option value="feb">Februari</option>
              <option value="mar">Maret</option>
              <option value="apr">April</option>
              <option value="mei">Mei</option>
              <option value="jun">Juni</option>
              <option value="jul">Juli</option>
              <option value="ags">Agustus</option>
              <option value="sep">September</option>
              <option value="okt">Oktober</option>
              <option value="nov">November</option>
              <option value="des">Desember</option>
            </select>
          </div>
          <a href="https://docs.google.com/spreadsheets/d/10GrrZ9akiB1--1DGJdEJtSkEapot2uLtdOC6wWbxLGg/edit?gid=1752999212#gid=1752999212" target="_blank" class="btn btn-sm btn-outline-danger rounded shadow mb-2">Input Data</a>
          <div class="table-responsive" style="font-size: 11px" shadow>
            <table class="table table-bordered table-striped align-middle mb-0" id="programTable" shadow>
              <thead class="table-success text-center align-middle">
                <tr id="tableHeaderMain"></tr>
                <tr id="tableHeaderSub"></tr>
              </thead>
              <tbody id="tableBody">
                <tr><td colspan="25" class="text-center">Memuat data...</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Scripts -->
          <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
          <script>
            const endpoint = "https://script.google.com/macros/s/AKfycbzcwt4BBtvpqEgCfY6wMp7HCfnzPOqqO1WF873oy6r-qB_cf_EhZi-0ZguiZYqMdZvb/exec";
            
            const bulanKeys = {
              jan: ["Jmlh_kunjungan_Jan", "Target_Jan", "capaian_Jan"],
              feb: ["Jmlh_kunjungan_Feb", "Target_Feb", "capaian_Feb"],
              mar: ["Jmlh_kunjungan_Mar", "Target_Mar", "capaian_Mar"],
              apr: ["Jmlh_kunjungan_Apr", "Target_Apr", "capaian_Apr"],
              mei: ["Jmlh_kunjungan_Mei", "Target_Mei", "capaian_Mei"],
              jun: ["Jmlh_kunjungan_Jun", "Target_Jun", "capaian_Jun"],
              jul: ["Jmlh_kunjungan_Jul", "Target_Jul", "capaian_Jul"],
              ags: ["Jmlh_kunjungan_Ags", "Target_Ags", "capaian_Ags"],
              sep: ["Jmlh_kunjungan_Sep", "Target_Sep", "capaian_Sep"],
              okt: ["Jmlh_kunjungan_Okt", "Target_Okt", "capaian_Okt"],
              nov: ["Jmlh_kunjungan_Nov", "Target_Nov", "capaian_Nov"],
              des: ["Jmlh_kunjungan_Des", "Target_Des", "capaian_Des"]
            };
            
            const bulanLabel = {
              jan: "Januari", feb: "Februari", mar: "Maret", apr: "April",
              mei: "Mei", jun: "Juni", jul: "Juli", ags: "Agustus",
              sep: "September", okt: "Oktober", nov: "November", des: "Desember"
            };
            
            let allData = [];
            
            function renderCell(value) {
            if (value === null || value === undefined || value === "") return `<td class="text-center">-</td>`;

            // cek apakah value bisa diubah ke angka
            const num = parseFloat(value);
            const displayValue = !isNaN(num) ? Math.round(num) : value;

            return `<td class="text-center">${displayValue}</td>`;
            }

            function formatPercent(val) {
                if (val === undefined || val === null || val === "") return "0%";
                let num = parseFloat(
                    String(val).replace(",", ".").replace("%", "").trim()
                );
                if (isNaN(num)) return val; // kalau bukan angka, tampilkan apa adanya
                if (num <= 1) num *= 100;
                return num.toFixed(2) + "%";
                }

            function renderHeader(filterBulan) {
              const mainHeader = document.getElementById("tableHeaderMain");
              const subHeader = document.getElementById("tableHeaderSub");
            
              let mainHTML = `
                <th rowspan="2"width="50px" class="text-wrap">No</th>
                <th rowspan="2"width="100px" class="text-wrap">Klaster</th>
                <th rowspan="2"width="100px" class="text-wrap">Kegiatan</th>
                <th rowspan="2" width="100px" class="text-wrap">Indikator Kerja</th>
                <th rowspan="2"width="100px" class="text-wrap">Target 2025</th>
                <th rowspan="2"width="100px" class="text-wrap">Satuan Sasaran</th>
                <th rowspan="2" width="100px" class="text-wrap">Total Sasaran</th>
                <th rowspan="2" width="100px" class="text-wrap">Target Sasaran</th>
                <th rowspan="2" width="100px" class="text-wrap">Pencapaian (dalam satuan sasaran)</th>
                <th rowspan="2" width="100px" class="text-wrap">% Cakupan Rill</th>
                <th rowspan="2"width="100px" class="text-wrap">Ketercapaian Target Tahun N</th>
              `;
            
              let subHTML = "";
            
              if (filterBulan === "all") {
                for (const key in bulanKeys) {
                  mainHTML += `<th colspan="3" class="table-success">${bulanLabel[key]}</th>`;
                  subHTML += `
                    <th width="100px" class="text-wrap">Jmlh Kunjungan</th>
                    <th width="100px" class="text-wrap">Target</th>
                    <th width="100px" class="text-wrap">Capaian</th>
                  `;
                }
              } else {
                mainHTML += `<th colspan="3" class="table-success">Capaian Bulan ${bulanLabel[filterBulan]}</th>`;
                subHTML += `
                  <th width="100px" class="text-wrap">Jmlh Kunjungan</th>
                  <th width="100px" class="text-wrap">Target</th>
                  <th width="100px" class="text-wrap">Capaian</th>
                `;
              }
            
              mainHeader.innerHTML = mainHTML;
              subHeader.innerHTML = subHTML;
            }
            
            function renderTable(data, filterBulan = "all") {
              const tableBody = document.getElementById("tableBody");
              tableBody.innerHTML = "";
              const fragment = document.createDocumentFragment();
              let index = 1;
            
              for (const row of data) {
                const clean = {};
                for (const key in row) clean[key.trim().toLowerCase()] = row[key];
                let html = `
                  <td>${index++}</td>
                  <td>${clean["klaster"] || "-"}</td>
                  <td>${clean["kegiatan"] || "-"}</td>
                  <td>${clean["indikator kerja"] || "-"}</td>
                  <td>${clean["target 2025"] || "-"}</td>
                  <td>${clean["satuan sasaran"] || "-"}</td>
                  <td>${clean["total sasaran"] || "-"}</td>
                  <td>${clean["target sasaran"] || "-"}</td>
                  <td>${
                    row["Pencapaian (dalam satuan sasaran)"]
                        ? formatPercent(row["Pencapaian (dalam satuan sasaran)"])
                        : "0%"
                    }</td>

                    <td>${
                    row["% Cakupan Rill"]
                        ? formatPercent(row["% Cakupan Rill"])
                        : "0%"
                    }</td>

                    <td>${
                    row["Ketercapaian Target Tahun N"]
                        ? formatPercent(row["Ketercapaian Target Tahun N"])
                        : "0%"
                    }</td>
                `;
            
                if (filterBulan === "all") {
                    for (const bulan in bulanKeys) {
                        for (const key of bulanKeys[bulan]) {
                        const value = row[key];
                        if (key.toLowerCase().includes("capaian")) {
                            html += renderCell(formatPercent(value));
                        } else {
                            html += renderCell(value);
                        }
                        }
                    }
                    } else {
                    for (const key of bulanKeys[filterBulan]) {
                        const value = row[key];
                        if (key.toLowerCase().includes("capaian")) {
                        html += renderCell(formatPercent(value));
                        } else {
                        html += renderCell(value);
                        }
                    }
                    }

            
                const tr = document.createElement("tr");
                tr.innerHTML = html;
                fragment.appendChild(tr);
              }
            
              tableBody.appendChild(fragment);
              renderHeader(filterBulan);
            }
            
            function loadData(defaultBulan) {
              const tableBody = document.getElementById("tableBody");
              tableBody.innerHTML = `
                <tr><td colspan="25" class="text-center py-4">
                  <div class="spinner-border text-success" role="status"></div>
                  <div class="mt-2 text-success fw-semibold">Memuat data...</div>
                </td></tr>`;
            
              fetch(endpoint)
                .then(res => res.json())
                .then(data => {
                  allData = data;
                  renderTable(allData, defaultBulan);
                })
                .catch(err => {
                  console.error(err);
                  tableBody.innerHTML = `<tr><td colspan="25" class="text-danger text-center">Gagal memuat data.</td></tr>`;
                });
            }
            
            // üîπ Event filter bulan
            document.getElementById("bulanFilter").addEventListener("change", (e) => {
              renderTable(allData, e.target.value);
            });
            
            // üîπ Default ke bulan sekarang
            const bulanList = ["jan","feb","mar","apr","mei","jun","jul","ags","sep","okt","nov","des"];
            const bulanSekarang = bulanList[new Date().getMonth()];
            document.getElementById("bulanFilter").value = bulanSekarang;
            
            // üîπ Load data awal
            loadData(bulanSekarang);
            </script>
          
          

    <!-- Modal -->
    <div
      class="modal fade"
      id="infoModal"
      tabindex="-1"
      aria-labelledby="infoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="infoModalLabel">Info</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Tutup"
            ></button>
          </div>
          <div class="modal-body" id="modalContent">...</div>
        </div>
      </div>
    </div>

    <!-- SCRIPT: letakkan di bawah semua konten -->
    <script>
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("show-info-btn")) {
          const type = e.target.dataset.type;
          const id = e.target.dataset.id;

          const row = rows.find((r) => String(r["No"]) === String(id)); // <= Perbaikan disini

          if (!row) return;

          const content = type === "DO" ? row["DO"] : row["Cara Penghitungan"];
          document.getElementById("modalContent").innerHTML =
            content || "<em>Belum ada data</em>";
          document.getElementById(
            "infoModalLabel"
          ).textContent = `${type} - No ${id}`;

          const modal = new bootstrap.Modal(
            document.getElementById("infoModal")
          );
          modal.show();
        }
      });
    </script>
    <script>
      document
        .getElementById("btnExportExcel")
        .addEventListener("click", function () {
          // Clone tabel agar tidak mengubah tampilan asli
          const tableClone = document
            .getElementById("programTable")
            .cloneNode(true);

          // Ganti semua <input> dengan nilai text
          tableClone.querySelectorAll("input").forEach((input) => {
            const td = input.parentElement;
            td.textContent = input.value; // pakai value yang ada sekarang
          });

          // Convert clone tabel ke worksheet Excel
          const wb = XLSX.utils.table_to_book(tableClone, {
            sheet: "Data Program",
          });

          // Simpan file Excel
          XLSX.writeFile(
            wb,
            `Data_Program_${new Date().toISOString().slice(0, 10)}.xlsx`
          );
        });
    </script>
  </body>
</html>
