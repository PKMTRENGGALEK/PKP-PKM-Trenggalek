<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report - Manajemen</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="auth.js"></script>
    <style>
      /* --- gaya global tetap --- */
      body {
        background: linear-gradient(to bottom, #ffffff, #c8facc);
        font-family: "Segoe UI", sans-serif;
        padding-top: 80px;
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .container {
        flex: 1;
      }

      .navbar {
        background-color: #ffffff;
        border-bottom: 1px solid #e0e0e0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .navbar-brand {
        font-weight: 600;
        color: #2e7d32 !important;
      }

      .section-title {
        text-align: center;
        margin: 20px 0;
        color: #2e7d32;
        font-size: 1.3rem;
        font-weight: 700;
      }

      .form-select {
        max-width: 280px;
        margin-bottom: 15px;
        font-size: 0.85rem;
        padding: 4px 8px;
      }

      .card {
        background-color: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 10px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      }

      .sticky-header {
        max-height: 450px;
        overflow-y: auto;
        border-radius: 10px;
        box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.05);
      }

      /* --- gaya tabel --- */
      table {
        font-size: 0.75rem; /* lebih kecil */
      }

      .table th,
      .table td {
        padding: 4px 6px; /* sel lebih rapat */
        vertical-align: middle;
      }

      .tableFixHead thead tr:nth-child(1) th {
        position: sticky;
        top: 0;
        background: #c1f0cb;
        z-index: 3;
      }

      .tableFixHead thead tr:nth-child(2) th {
        position: sticky;
        top: 28px; /* sesuaikan dengan tinggi baris 1 */
        background: #c1f0cb;
        z-index: 2;
      }

      footer {
        background: rgba(255, 255, 255, 0.8);
        text-align: center;
        padding: 0.6rem;
        font-size: 0.8rem;
        color: #555;
        box-shadow: 0 -1px 6px rgba(0, 0, 0, 0.05);
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar fixed-top bg-white shadow-sm">
      <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="#">PKP 2025 - Data Program</a>
      </div>
    </nav>

    <!-- Konten -->
    <div class="container">
      <div class="card shadow">
        <div class="card-body">
          <a href="home.html" class="btn btn-outline-success shadow-sm">
            ‚¨ÖÔ∏è Kembali
          </a>
          <h2 class="section-title">
            Instrumen Penghitungan Klaster Pelayanan Manajemen
          </h2>

         <div class="d-flex justify-content-between align-items-center mb-3">
            <!-- Filter Program -->
            <select class="form-select" id="filterProgram" style="max-width:280px;">
                <option value="">Semua Program</option>
            </select>

            <!-- Tombol Export -->
            <button id="exportExcel" class="btn btn-outline-primary shadow ms-2">
                üñ® Export Excel
            </button>
          </div>
          <!-- Tabel -->
          <div class="table-responsive tableFixHead sticky-header">
            <table
              class="table table-bordered table-striped align-middle"
              id="programTable"
            >
              <thead class="table-success text-center align-middle">
                <tr>
                  <th rowspan="2">No</th>
                  <th rowspan="2" style="min-width: 120px">Jenis Variabel</th>
                  <th rowspan="2" style="min-width: 250px">
                    Definisi Operasional
                  </th>
                  <th colspan="4">Skala</th>
                  <th rowspan="2">Nilai</th>
                  <th rowspan="2">Bobot</th>
                  <th rowspan="2">Nilai Total</th>
                </tr>
                <tr>
                  <th>0</th>
                  <th>4</th>
                  <th>7</th>
                  <th>10</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr id="loadingRow">
                  <td colspan="10" class="text-center py-4">
                    <div
                      class="spinner-border text-success"
                      role="status"
                    ></div>
                    <div class="mt-2 text-success fw-semibold">
                      Memuat data...
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="fixed-bottom">
      &copy; 2025 Puskesmas Trenggalek | Data Program PKP
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script Ambil Data + Filter -->
    <script>
      const endpoint =
        "https://script.google.com/macros/s/AKfycbw2Wv6lToH5rFh4FiYWm-5DZTUyC3ZTCm3wF_9CTqvz7cSUVx_Hs4uSRPGDT3qGGARlcQ/exec";

      const tableBody = document.getElementById("tableBody");
      const filterProgram = document.getElementById("filterProgram");
      let allData = [];

      async function loadData() {
        try {
          const res = await fetch(endpoint);
          const data = await res.json();
          allData = data;

          populateFilter(data);
          renderTable(data);
        } catch (err) {
          tableBody.innerHTML = `<tr><td colspan="10" class="text-danger text-center">Gagal memuat data</td></tr>`;
        }
      }

      function populateFilter(data) {
        const programs = [...new Set(data.map((d) => d.Program))];
        programs.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p;
          opt.textContent = p;
          filterProgram.appendChild(opt);
        });
      }

      function renderTable(data) {
        if (!data.length) {
          tableBody.innerHTML =
            '<tr><td colspan="10" class="text-center">Tidak ada data</td></tr>';
          return;
        }
        tableBody.innerHTML = "";
        data.forEach((row, i) => {
          tableBody.innerHTML += `
            <tr>
              <td class="text-start">${i + 1}</td>
              <td class="text-start">${row["Jenis Variabel"] || ""}</td>
              <td class="text-start">${row["Definisi Operasional"] || ""}</td>
              <td>${row["0"] || ""}</td>
              <td>${row["4"] || ""}</td>
              <td>${row["7"] || ""}</td>
              <td>${row["10"] || ""}</td>
              <td>${row["Nilai"] || ""}</td>
              <td>${row["Bobot"] || ""}</td>
              <td>${row["Nilai Total"] || ""}</td>
            </tr>
          `;
        });
      }

      filterProgram.addEventListener("change", () => {
        const val = filterProgram.value;
        const filtered = val
          ? allData.filter((d) => d.Program === val)
          : allData;
        renderTable(filtered);
      });
      document.getElementById("exportExcel").addEventListener("click", () => {
  // Ambil tabel
  const table = document.getElementById("programTable");
  // Konversi tabel ke worksheet
  const wb = XLSX.utils.table_to_book(table, { sheet: "Data Program" });
  // Download file excel
  XLSX.writeFile(wb, "Data_P2_Kesling.xlsx");
});
      loadData();
    </script>
  </body>
</html>
